'use strict';

/* eslint max-len:0 */
var themes = require('../../themes');
var tools = require('../../tools');

var _ = require('lodash');
var chalk = require('chalk');
var moment = require('moment');
var http = require('good-guy-http')();
var noon = require('noon');

var CFILE = process.env.HOME + '/.leximaven.noon';

exports.command = 'get <condition>';
exports.desc = 'Datamuse query';
exports.builder = {
  out: {
    alias: 'o',
    desc: 'Write cson, json, noon, plist, yaml, xml',
    default: '',
    type: 'string'
  },
  force: {
    alias: 'f',
    desc: 'Force overwriting outfile',
    default: false,
    type: 'boolean'
  },
  save: {
    alias: 's',
    desc: 'Save flags to config file',
    default: false,
    type: 'boolean'
  },
  max: {
    alias: 'm',
    desc: 'Maximum number of results, 1 to 1000',
    default: 5,
    type: 'number'
  }
};
exports.handler = function (argv) {
  tools.checkConfig(CFILE);
  var config = noon.load(CFILE);
  var proceed = false;
  var stamp = new Date(config.dmuse.date.stamp);
  var hours = moment(new Date()).diff(stamp, 'hours');
  var minutes = moment(new Date()).diff(stamp, 'minutes');
  var reset = false;
  if (hours < 24) {
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  } else if (hours >= 24) {
    reset = true;
    config.dmuse.date.stamp = moment().format();
    config.dmuse.date.remain = config.dmuse.date.limit;
    console.log(chalk.white('Reset API limit to ' + config.dmuse.date.limit + '/' + config.dmuse.date.interval + '.'));
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  }
  if (config.dmuse.date.remain === 0) {
    proceed = false;
  } else if (config.dmuse.date.remain < 0) {
    proceed = false;
    config.dmuse.date.remain = 0;
    noon.save(CFILE, config);
  } else {
    proceed = true;
  }
  if (proceed) {
    (function () {
      var userConfig = {
        dmuse: {
          max: argv.m
        }
      };
      if (config.merge) config = _.merge({}, config, userConfig);
      var theme = themes.loadTheme(config.theme);
      if (config.verbose) themes.labelDown('Datamuse', theme, null);
      var ccont = [];
      ccont.push(argv.condition);
      if (argv._.length > 1) {
        _.each(argv._, function (value) {
          ccont.push(value);
        });
      }
      var prefix = 'http://api.datamuse.com/words?';
      var conditions = 'max=' + config.dmuse.max + '&';
      _.each(ccont, function (value) {
        conditions = conditions + '&' + value;
      });
      var url = '' + prefix + conditions;
      url = encodeURI(url);
      var tags = {
        n: 'noun',
        adj: 'adjective',
        adv: 'adverb',
        syn: 'synonym'
      };
      var tofile = {
        type: 'datamuse',
        source: 'http://datamuse.com/api',
        url: url
      };
      var ctstyle = _.get(chalk, theme.content.style);
      http({ url: url }, function (error, response) {
        if (!error && response.statusCode === 200) {
          var resp = JSON.parse(response.body);
          for (var i = 0; i <= resp.length - 1; i++) {
            var item = resp[i];
            themes.labelRight('Match', theme, item.word + ' ');
            tofile[['match' + i]] = item.word;
            if (item.tags !== undefined && item.tags !== []) {
              themes.labelRight('Tags', theme, null);
              for (var j = 0; j <= item.tags.length - 1; j++) {
                if (j === item.tags.length - 1) {
                  process.stdout.write(ctstyle('' + tags[item.tags[j]]));
                  tofile[['tags' + j]] = tags[item.tags[j]];
                } else {
                  process.stdout.write(ctstyle(tags[item.tags[j]] + ', '));
                }
              }
              console.log('');
            }
          }
          if (argv.o) tools.outFile(argv.o, argv.f, tofile);
          if (argv.s && config.merge) noon.save(CFILE, config);
          if (argv.s && !config.merge) console.err(chalk.red('Set option merge to true!'));
          if (reset) {
            console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today.');
          } else {
            console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today, will reset in ' + (23 - hours) + ' hours, ' + (59 - minutes) + ' minutes.');
          }
        } else {
          console.error(chalk.red.bold('HTTP ' + response.statusCode + ':') + ' ' + chalk.red(error));
        }
      });
    })();
  } else {
    console.error(chalk.red('Reached today\'s usage limit of ' + config.dmuse.date.limit + '.'));
    process.exit(1);
  }
};
//# sourceMappingURL=data:application/json;base64,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Q0FBYjtBQUNEO0FBQ0YsQ0FuR0QiLCJmaWxlIjoiY21kcy9kbXVzZV9jbWRzL2dldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBtYXgtbGVuOjAgKi9cbmNvbnN0IHRoZW1lcyA9IHJlcXVpcmUoJy4uLy4uL3RoZW1lcycpXG5jb25zdCB0b29scyA9IHJlcXVpcmUoJy4uLy4uL3Rvb2xzJylcblxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5jb25zdCBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJylcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpXG5jb25zdCBodHRwID0gcmVxdWlyZSgnZ29vZC1ndXktaHR0cCcpKClcbmNvbnN0IG5vb24gPSByZXF1aXJlKCdub29uJylcblxuY29uc3QgQ0ZJTEUgPSBgJHtwcm9jZXNzLmVudi5IT01FfS8ubGV4aW1hdmVuLm5vb25gXG5cbmV4cG9ydHMuY29tbWFuZCA9ICdnZXQgPGNvbmRpdGlvbj4nXG5leHBvcnRzLmRlc2MgPSAnRGF0YW11c2UgcXVlcnknXG5leHBvcnRzLmJ1aWxkZXIgPSB7XG4gIG91dDoge1xuICAgIGFsaWFzOiAnbycsXG4gICAgZGVzYzogJ1dyaXRlIGNzb24sIGpzb24sIG5vb24sIHBsaXN0LCB5YW1sLCB4bWwnLFxuICAgIGRlZmF1bHQ6ICcnLFxuICAgIHR5cGU6ICdzdHJpbmcnLFxuICB9LFxuICBmb3JjZToge1xuICAgIGFsaWFzOiAnZicsXG4gICAgZGVzYzogJ0ZvcmNlIG92ZXJ3cml0aW5nIG91dGZpbGUnLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgfSxcbiAgc2F2ZToge1xuICAgIGFsaWFzOiAncycsXG4gICAgZGVzYzogJ1NhdmUgZmxhZ3MgdG8gY29uZmlnIGZpbGUnLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgfSxcbiAgbWF4OiB7XG4gICAgYWxpYXM6ICdtJyxcbiAgICBkZXNjOiAnTWF4aW11bSBudW1iZXIgb2YgcmVzdWx0cywgMSB0byAxMDAwJyxcbiAgICBkZWZhdWx0OiA1LFxuICAgIHR5cGU6ICdudW1iZXInLFxuICB9LFxufVxuZXhwb3J0cy5oYW5kbGVyID0gKGFyZ3YpID0+IHtcbiAgdG9vbHMuY2hlY2tDb25maWcoQ0ZJTEUpXG4gIGxldCBjb25maWcgPSBub29uLmxvYWQoQ0ZJTEUpXG4gIGxldCBwcm9jZWVkID0gZmFsc2VcbiAgY29uc3Qgc3RhbXAgPSBuZXcgRGF0ZShjb25maWcuZG11c2UuZGF0ZS5zdGFtcClcbiAgY29uc3QgaG91cnMgPSBtb21lbnQobmV3IERhdGUpLmRpZmYoc3RhbXAsICdob3VycycpXG4gIGNvbnN0IG1pbnV0ZXMgPSBtb21lbnQobmV3IERhdGUpLmRpZmYoc3RhbXAsICdtaW51dGVzJylcbiAgbGV0IHJlc2V0ID0gZmFsc2VcbiAgaWYgKGhvdXJzIDwgMjQpIHtcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH0gZWxzZSBpZiAoaG91cnMgPj0gMjQpIHtcbiAgICByZXNldCA9IHRydWVcbiAgICBjb25maWcuZG11c2UuZGF0ZS5zdGFtcCA9IG1vbWVudCgpLmZvcm1hdCgpXG4gICAgY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID0gY29uZmlnLmRtdXNlLmRhdGUubGltaXRcbiAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgUmVzZXQgQVBJIGxpbWl0IHRvICR7Y29uZmlnLmRtdXNlLmRhdGUubGltaXR9LyR7Y29uZmlnLmRtdXNlLmRhdGUuaW50ZXJ2YWx9LmApKVxuICAgIGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9IGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiAtIDFcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGNvbmZpZylcbiAgfVxuICBpZiAoY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID09PSAwKSB7XG4gICAgcHJvY2VlZCA9IGZhbHNlXG4gIH0gZWxzZSBpZiAoY29uZmlnLmRtdXNlLmRhdGUucmVtYWluIDwgMCkge1xuICAgIHByb2NlZWQgPSBmYWxzZVxuICAgIGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9IDBcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGNvbmZpZylcbiAgfSBlbHNlIHtcbiAgICBwcm9jZWVkID0gdHJ1ZVxuICB9XG4gIGlmIChwcm9jZWVkKSB7XG4gICAgY29uc3QgdXNlckNvbmZpZyA9IHtcbiAgICAgIGRtdXNlOiB7XG4gICAgICAgIG1heDogYXJndi5tLFxuICAgICAgfSxcbiAgICB9XG4gICAgaWYgKGNvbmZpZy5tZXJnZSkgY29uZmlnID0gXy5tZXJnZSh7fSwgY29uZmlnLCB1c2VyQ29uZmlnKVxuICAgIGNvbnN0IHRoZW1lID0gdGhlbWVzLmxvYWRUaGVtZShjb25maWcudGhlbWUpXG4gICAgaWYgKGNvbmZpZy52ZXJib3NlKSB0aGVtZXMubGFiZWxEb3duKCdEYXRhbXVzZScsIHRoZW1lLCBudWxsKVxuICAgIGNvbnN0IGNjb250ID0gW11cbiAgICBjY29udC5wdXNoKGFyZ3YuY29uZGl0aW9uKVxuICAgIGlmIChhcmd2Ll8ubGVuZ3RoID4gMSkge1xuICAgICAgXy5lYWNoKGFyZ3YuXywgKHZhbHVlKSA9PiB7XG4gICAgICAgIGNjb250LnB1c2godmFsdWUpXG4gICAgICB9KVxuICAgIH1cbiAgICBjb25zdCBwcmVmaXggPSAnaHR0cDovL2FwaS5kYXRhbXVzZS5jb20vd29yZHM/J1xuICAgIGxldCBjb25kaXRpb25zID0gYG1heD0ke2NvbmZpZy5kbXVzZS5tYXh9JmBcbiAgICBfLmVhY2goY2NvbnQsICh2YWx1ZSkgPT4ge1xuICAgICAgY29uZGl0aW9ucyA9IGAke2NvbmRpdGlvbnN9JiR7dmFsdWV9YFxuICAgIH0pXG4gICAgbGV0IHVybCA9IGAke3ByZWZpeH0ke2NvbmRpdGlvbnN9YFxuICAgIHVybCA9IGVuY29kZVVSSSh1cmwpXG4gICAgY29uc3QgdGFncyA9IHtcbiAgICAgIG46ICdub3VuJyxcbiAgICAgIGFkajogJ2FkamVjdGl2ZScsXG4gICAgICBhZHY6ICdhZHZlcmInLFxuICAgICAgc3luOiAnc3lub255bScsXG4gICAgfVxuICAgIGNvbnN0IHRvZmlsZSA9IHtcbiAgICAgIHR5cGU6ICdkYXRhbXVzZScsXG4gICAgICBzb3VyY2U6ICdodHRwOi8vZGF0YW11c2UuY29tL2FwaScsXG4gICAgICB1cmwsXG4gICAgfVxuICAgIGNvbnN0IGN0c3R5bGUgPSBfLmdldChjaGFsaywgdGhlbWUuY29udGVudC5zdHlsZSlcbiAgICBodHRwKHsgdXJsIH0sIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIGlmICghZXJyb3IgJiYgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHJlc3AubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHJlc3BbaV1cbiAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnTWF0Y2gnLCB0aGVtZSwgYCR7aXRlbS53b3JkfSBgKVxuICAgICAgICAgIHRvZmlsZVtbYG1hdGNoJHtpfWBdXSA9IGl0ZW0ud29yZFxuICAgICAgICAgIGlmIChpdGVtLnRhZ3MgIT09IHVuZGVmaW5lZCAmJiBpdGVtLnRhZ3MgIT09IFtdKSB7XG4gICAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnVGFncycsIHRoZW1lLCBudWxsKVxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gaXRlbS50YWdzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgICAgICAgICBpZiAoaiA9PT0gaXRlbS50YWdzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjdHN0eWxlKGAke3RhZ3NbaXRlbS50YWdzW2pdXX1gKSlcbiAgICAgICAgICAgICAgICB0b2ZpbGVbW2B0YWdzJHtqfWBdXSA9IHRhZ3NbaXRlbS50YWdzW2pdXVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGN0c3R5bGUoYCR7dGFnc1tpdGVtLnRhZ3Nbal1dfSwgYCkpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCcnKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJndi5vKSB0b29scy5vdXRGaWxlKGFyZ3YubywgYXJndi5mLCB0b2ZpbGUpXG4gICAgICAgIGlmIChhcmd2LnMgJiYgY29uZmlnLm1lcmdlKSBub29uLnNhdmUoQ0ZJTEUsIGNvbmZpZylcbiAgICAgICAgaWYgKGFyZ3YucyAmJiAhY29uZmlnLm1lcmdlKSBjb25zb2xlLmVycihjaGFsay5yZWQoJ1NldCBvcHRpb24gbWVyZ2UgdG8gdHJ1ZSEnKSlcbiAgICAgICAgaWYgKHJlc2V0KSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYCR7Y29uZmlnLmRtdXNlLmRhdGUucmVtYWlufS8ke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fSByZXF1ZXN0cyByZW1haW5pbmcgdG9kYXkuYClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgJHtjb25maWcuZG11c2UuZGF0ZS5yZW1haW59LyR7Y29uZmlnLmRtdXNlLmRhdGUubGltaXR9IHJlcXVlc3RzIHJlbWFpbmluZyB0b2RheSwgd2lsbCByZXNldCBpbiAkezIzIC0gaG91cnN9IGhvdXJzLCAkezU5IC0gbWludXRlc30gbWludXRlcy5gKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGAke2NoYWxrLnJlZC5ib2xkKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX06YCl9ICR7Y2hhbGsucmVkKGVycm9yKX1gKVxuICAgICAgfVxuICAgIH0pXG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFJlYWNoZWQgdG9kYXkncyB1c2FnZSBsaW1pdCBvZiAke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fS5gKSlcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfVxufVxuIl19